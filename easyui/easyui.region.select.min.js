function log(e){}
var globalE="";

function CopyPasteClass(){
    var e=this,t,a;
    this.copyCallbacks=[],this.cutCallbacks=[],this.pasteCallbacks=[];
    var r=document.documentElement;
    a=document.body,document.getElementById("CopyPasteDiv")?(this.elDiv=document.getElementById("CopyPasteDiv"),this.elTextarea=this.elDiv.firstChild):(this.elDiv=document.createElement("DIV"),this.elDiv.id="CopyPasteDiv",t=this.elDiv.style,t.position="fixed",t.top="50%",t.left="50%",a.appendChild(this.elDiv),this.elTextarea=document.createElement("TEXTAREA"),this.elTextarea.className="copyPaste",t=this.elTextarea.style,t.width="1px",t.height="1px",this.elDiv.appendChild(this.elTextarea),"undefined"!=typeof t.opacity&&(t.opacity=0)),this._bindEvent(r,"keydown",function(t){
        var a=!1;
        if(t.metaKey?a=!0:t.ctrlKey&&-1===navigator.userAgent.indexOf("Mac")&&(a=!0),a){
            if(document.activeElement!==e.elTextarea&&(""!=e.getSelectionText()||-1!=["INPUT","SELECT","TEXTAREA"].indexOf(document.activeElement.nodeName)))return;
            e.selectNodeText(e.elTextarea),setTimeout(function(){
                e.selectNodeText(e.elTextarea)
            },0)
        }!a||67!==t.keyCode&&86!==t.keyCode&&88!==t.keyCode||(88===t.keyCode?setTimeout(function(){
            e.triggerCut(t)
        },0):86===t.keyCode&&setTimeout(function(){
            e.triggerPaste(t)
        },0))
    })
}
function judgeNav(){
    var e={},t=navigator.userAgent;
    return e.isOpera=t.indexOf("Opera")>-1,e.isMaxthon=t.indexOf("Maxthon")>-1,e.isIE=t.indexOf("compatible")>-1&&t.indexOf("MSIE")>-1&&!e.isOpera,e.isFF=t.indexOf("Firefox")>-1,e.isSafari=t.indexOf("Safari")>-1&&t.indexOf("Chrome")<1,e.isChrome=t.indexOf("Chrome")>-1,e
}

var LEAUI_Region_Select={};

LEAUI_Region_Select.setCur=function(e){
    
    $(e).addClass("td-start"),LEAUI_Region_Select.cp.copyable($(e).text())
//    e = globalE;
//    var field = $(".td-start");
//    var fieldName = field.attr("field");
//    
//    var row = $(e).datagrid("getSelected");
//    var index = $(globalE).datagrid('getRowIndex',row);
//    $(e).datagrid('beginEdit', index);
//    var editor = $(globalE).datagrid('getEditor', {
//        index:index,
//        field:fieldName
//    });
//    console.log(field);
//    console.log("fieldname: "+fieldName);
//    
//    console.log(editor);
//    field.html(editor);
    //$(editor.target).focus();
    
    
},LEAUI_Region_Select.getCur=function(e){
    return!e&&$(".td-start").length>0?$(".td-start").eq($(".td-start").length-1):$(e).find(".td-start")
},LEAUI_Region_Select.getTopP=function(e){
    return $(e).parents().find(".datagrid-view")
},LEAUI_Region_Select.getPos=function(e){
    var t=$(e).parent(),a=t.attr("id");
    if(a){
        var r=a.split("-"),n=+r[3],i=r[0]+"-"+r[1]+"-"+r[2],o=+t.attr("datagrid-row-index"),l=0,s=0;
        return $(t).find("td").each(function(){
            $(this).html()==$(e).html()&&(l=s),s++
        }),{
            tableNumPrefix:i,
            tableNum:n,
            trIndex:o,
            tdIndex:l
        }
    }
},LEAUI_Region_Select.clearArea=function(e){
    e.find(".datagrid-cell").parent().removeClass("td-start").removeClass("td-selected")
},LEAUI_Region_Select.clearCur=function(e){
    e.find(".datagrid-cell").parent().removeClass("td-selected")
},LEAUI_Region_Select.getTrId=function(e,t,a){
    return e+"-"+t+"-"+a
},LEAUI_Region_Select.hasLeft=function(e,t){
    var a=LEAUI_Region_Select.getTrId(e,t-1,0);
    return 0==$("#"+a).length?!1:!0
},LEAUI_Region_Select.hasRight=function(e,t){
    var a=getTrId(e,t+1,0);
    return 0==$("#"+a).length?!1:!0
},
LEAUI_Region_Select.hasNextTr=function(e,t){

    },
    $(document).on("keydown","body",function(e){
        var t=e.target.tagName;
        //        if("INPUT"!=t&&"TEXTAREA"!=t){
        var a=LEAUI_Region_Select.getCur();
        if(a){
            var r=LEAUI_Region_Select.getTopP(a);
            if(r){
                var n=LEAUI_Region_Select.getPos(a);
                if(n){
                    var i=n.tableNumPrefix+"-"+n.tableNum+"-";
                    var o=a.closest(".datagrid-body");
                    var l=o.height();
                    var s=o.width();
                    var d=Math.floor(l/25);
                    var c=o.get(0);
                    var u=e.keyCode?e.keyCode:e.which?e.which:e.charCode;
                    switch(u){
                        case 40:
                            //alert('tesr');                            
                            e.preventDefault();
                            var f=n.trIndex+1,g=$("tr#"+i+f+" td");
                            //                            alert(f);
                            console.log(globalE);
                            //                                $(globalE).datagrid('beginEdit', 2);

                            var row = $(globalE).datagrid('getSelected');
                            var index = $(globalE).datagrid('getRowIndex',row);
                            console.log(index);
                            //$(globalE).datagrid('beginEdit', index + 1);
                            //                                $(globalE).datagrid('beginEdit', {
                            //                                    index:index,
                            //                                    field:'company'
                            //                                });
                                
                            $(globalE).datagrid('beginEdit', index);
                                
                    
                            if(0==g.length)return;
                            LEAUI_Region_Select.clearCur(r),a.removeClass("td-start"),LEAUI_Region_Select.setCur(g.eq(n.tdIndex));
                            var p=f+1,h=c.scrollTop,v=25*p;
                            if(v>h&&h+l>v)return;
                            var C=25*(p-d)+3;
                            o.scrollTop(C);                            
                            break;
                        case 38:
                            e.preventDefault();
                            var f=n.trIndex-1,g=$("tr#"+i+f+" td");
                            //                                alert(f);
                            if(0==g.length)return;
                            LEAUI_Region_Select.clearCur(r),a.removeClass("td-start"),LEAUI_Region_Select.setCur(g.eq(n.tdIndex));
                            var p=f+1,h=c.scrollTop,v=25*p;
                            if(v>h&&h+l>v)return;
                            o.scrollTop(v-25);
                            break;
                        case 37:
                            e.preventDefault();
                            var m=n.tdIndex-1;
                            //                                alert(m);
                            if(0>m){
                                var i=n.tableNumPrefix+"-"+(n.tableNum-1)+"-"+n.trIndex,g=$("tr#"+i+" td");
                                if(0==g.length||"datagrid-td-rownumber"==g.eq(0).attr("class")){
                                    return;
                                    var x=n.tableNum;
                                    LEAUI_Region_Select.hasRight(n.tableNumPrefix,n.tableNum)&&(x+=1);
                                    var I=LEAUI_Region_Select.getTrId(n.tableNumPrefix,x,n.trIndex-1),g=$("tr#"+I+" td");
                                    if(0==g.length)return;
                                    m=g.length-1
                                }
                            }else var g=$("tr#"+i+n.trIndex+" td");
                            LEAUI_Region_Select.clearCur(r),a.removeClass("td-start"),LEAUI_Region_Select.setCur(g.eq(m));
                            for(var b=m+1,_=0,y=0;m>=y;++y)_+=g.eq(y).width();
                            o.get(0).scrollLeft=_-s;
                            break;
                        case 39:
                            e.preventDefault();
                            var m=n.tdIndex+1,g=$("tr#"+i+n.trIndex+" td");
                            //                                alert(m);
                            if(g.length<=m){
                                var i=n.tableNumPrefix+"-"+(n.tableNum+1)+"-"+n.trIndex,g=$("tr#"+i+" td");
                                if(0==g.length){
                                    return;
                                    var x=n.tableNum;
                                    if(LEAUI_Region_Select.hasLeft(n.tableNumPrefix,n.tableNum)){
                                        x-=1;
                                        var E=LEAUI_Region_Select.getTrId(n.tableNumPrefix,x,n.trIndex+1);
                                        "datagrid-td-rownumber"==$("tr#"+E+" td").eq(0).attr("class")&&(x+=1)
                                    }
                                    var I=LEAUI_Region_Select.getTrId(n.tableNumPrefix,x,n.trIndex+1),g=$("tr#"+I+" td");
                                    if(0==g.length)return;
                                    m=0
                                }else m=0
                            }
                            LEAUI_Region_Select.clearCur(r),a.removeClass("td-start"),LEAUI_Region_Select.setCur(g.eq(m));
                            for(var _=0,y=0;m>=y;++y)_+=g.eq(y).width();
                            o.get(0).scrollLeft=_-s
                            break;
                        case 13:
                            $(globalE).datagrid('endEdit');
                           
                    }
                }
            }
        //            }
        }
    }),
    $.extend($.fn.datagrid.methods,{
        regionSelect:function(e){
            globalE=e;
            function t(e){
                return void 0!=e.which&&1==e.which||1==e.button?1:void 0!=e.which&&3==e.which||2==e.button?2:void 0
            }
            return LEAUI_Region_Select.cp=CopyPaste.getInstance(),e.each(function(){
                function e(){
                    $("body").unbind("selectstart")
                }
                function a(){
                    $("body").on("selectstart",function(e){
                        return event.preventDefault(),!1
                    })
                }
                function r(e,t){
                    if(e.start&&e.start.tableNum&&e.end.tableNum){
                        if(e.start.tableNum==e.end.tableNum){
                            var a=e.start.tableNumPrefix+"-"+e.start.tableNum;
                            t?$("tr#"+a+"-0").parent().find("td").removeClass("td-selected"):LEAUI_Region_Select.clearCur(o),trStart=Math.min(e.start.trIndex,e.end.trIndex),trEnd=Math.max(e.start.trIndex,e.end.trIndex),tdStart=Math.min(e.start.tdIndex,e.end.tdIndex),tdEnd=Math.max(e.start.tdIndex,e.end.tdIndex);
                            for(var n="",i=[],l=trStart;trEnd>=l;++l){
                                for(var s=$("tr#"+a+"-"+l+" td"),d=[],c=tdStart;tdEnd>=c;++c)s.eq(c).addClass("td-selected"),d.push(s.eq(c).text()),n+=s.eq(c).text(),c!=tdEnd&&(n+="	");
                                i.push(d),n+="\r\n"
                            }
                            return t||LEAUI_Region_Select.cp.copyable(n),i
                        }
                        var u,f;
                        e.start.tableNum<e.end.tableNum?(u=e.start,f=e.end):(u=e.end,f=e.start);
                        for(var a=e.start.tableNumPrefix+"-"+e.start.tableNum+"-0",g=$("tr#"+a+" td").length-1,p=f.trIndex,h=$.extend({},u,{
                            trIndex:p,
                            tdIndex:g
                        }),v=r({
                            start:u,
                            end:h
                        },!0),g=0,p=u.trIndex,h=$.extend({},f,{
                            trIndex:p,
                            tdIndex:g
                        }),C=r({
                            start:f,
                            end:h
                        },!0),n="",l=0;l<v.length;++l)n+=v[l].join("	")+"	"+C[l].join("	")+"\r\n";
                        LEAUI_Region_Select.cp.copyable(n)
                    }
                }
                var n={
                    start:null,
                    end:null
                },i=!1,o=$(this).datagrid("getPanel");
                o.on("mousedown",".datagrid-btable td",function(e){
                    var a=t(e);
                    if(2!=a){
                        $("#CopyPasteDiv textarea").focus();
                        var l=e.target;
                        if("TD"!=$(l).get(0).tagName)for(var s=$(l).parents(),d=0;d<s.length;++d)if("TD"==s.eq(d).get(0).tagName){
                            l=s.eq(d);
                            break
                        }
                        var c=$(l).attr("class");
                        if(!("ck"==$(l).attr("field")||c&&-1!=c.indexOf("datagrid-td-rownumber"))){
                            var u=LEAUI_Region_Select.getPos(l);
                            if(u){
                                if(e.shiftKey){
                                    var f=LEAUI_Region_Select.getCur(o);
                                    if(f)return n.end=u,void r(n)
                                }
                                n.start=u,LEAUI_Region_Select.clearArea(o),i=!0,LEAUI_Region_Select.setCur(l)
                            }
                        }
                    }
                }),o.on("mousemove",".datagrid-btable td",function(e){
                    if(i){
                        a();
                        var t=e.target;
                        if("TD"!=$(t).get(0).tagName)for(var o=$(t).parents(),l=0;l<o.length;++l)if("TD"==o.eq(l).get(0).tagName){
                            t=o.eq(l);
                            break
                        }
                        var s=$(t).attr("class");
                        if(!("ck"==$(t).attr("field")||s&&-1!=s.indexOf("datagrid-td-rownumber"))){
                            var d=LEAUI_Region_Select.getPos(t);
                            n.end=d,r(n)
                        }
                    }
                }),$("body").on("mouseup",function(){
                    i=!1,e()
                }),o.parent().css("-moz-user-select","none"),o.parent().on("selectstart",function(e){
                    return e.preventDefault(),!1
                })
            })
        }
    });
var CopyPaste=function(){
    var e;
    return{
        getInstance:function(){
            return e||(e=new CopyPasteClass),e
        }
    }
}(),cpJudgeNav=judgeNav();
CopyPasteClass.prototype.selectNodeText=function(e){
    e.select()
},CopyPasteClass.prototype.getSelectionText=function(){
    var e="";
    return window.getSelection?e=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(e=document.selection.createRange().text),e
},CopyPasteClass.prototype.copyable=function(e){
    if("string"!=typeof e&&void 0===e.toString)throw new Error("copyable requires string parameter");
    this.elTextarea.value=e
},CopyPasteClass.prototype.onCut=function(e){
    this.cutCallbacks.push(e)
},CopyPasteClass.prototype.onPaste=function(e){
    this.pasteCallbacks.push(e)
},CopyPasteClass.prototype.removeCallback=function(e){
    var t,a;
    for(t=0,a=this.copyCallbacks.length;a>t;t++)if(this.copyCallbacks[t]===e)return this.copyCallbacks.splice(t,1),!0;for(t=0,a=this.cutCallbacks.length;a>t;t++)if(this.cutCallbacks[t]===e)return this.cutCallbacks.splice(t,1),!0;for(t=0,a=this.pasteCallbacks.length;a>t;t++)if(this.pasteCallbacks[t]===e)return this.pasteCallbacks.splice(t,1),!0;return!1
},CopyPasteClass.prototype.triggerCut=function(e){
    var t=this;
    t.cutCallbacks&&setTimeout(function(){
        for(var a=0,r=t.cutCallbacks.length;r>a;a++)t.cutCallbacks[a](e)
    },50)
},CopyPasteClass.prototype.triggerPaste=function(e,t){
    var a=this;
    a.pasteCallbacks&&setTimeout(function(){
        for(var r=(t||a.elTextarea.value).replace(/\n$/,""),n=0,i=a.pasteCallbacks.length;i>n;n++)a.pasteCallbacks[n](r,e)
    },50)
},CopyPasteClass.prototype._bindEvent=function(){
    return window.jQuery?function(e,t,a){
        $(e).on(t+".copypaste",a)
    }:function(e,t,a){
        e.addEventListener(t,a,!1)
    }
}();




